# DREAM: 소수 실제 이상 데이터로 정확도·리콜 획기적 향상 전략

## 배경

- **현재**: DREAM(DRAEM 전략)은 **정상 데이터만**으로 학습하며, 합성 이상(정상+노이즈)으로 판별기를 함께 학습한다.
- **목표**: 현미경 정밀검사로 **FPCB 구리배선 크랙이 벤딩 중 발생한 것이 확인된** 소수의 실제 이상 패널에 대한 벤딩 과정 측면 촬영 영상 데이터를 활용해, 비정상 탐지의 **정확도와 리콜을 획기적으로 끌어올린다**.

## 전제 데이터

- **실제 이상 데이터**: 벤딩 중 측면 촬영 영상 → contour/frame 시퀀스 → `run_analysis` 등으로 추출한 **프레임/세션별 특징** (또는 기존 ML 파이프라인과 동일한 특징).
- **양**: 소수 (예: 수 개~수십 개 세션 또는 수백~수천 프레임 수준). 라벨: **이상(크랙) = 1**.

## 전략 요약

1. **1단계 (현재 완료)**: 정상만 + 합성 이상으로 DREAM 학습 → 기본 판별기·재구성기 확보.
2. **2단계 (소수 실제 이상 활용)**  
   - **옵션 A — 판별기만 소수 실제 이상으로 미세조정(fine-tuning)**  
     - 재구성 서브넷은 고정.  
     - 판별기 입력: (입력, 재구성).  
     - 소수 실제 이상 샘플 + 기존 정상(또는 정상 서브샘플)으로 **판별기만** BCE/CrossEntropy로 추가 학습.  
     - 목표: 실제 크랙 패턴에 맞는 결정 경계로 **리콜·정확도 상승**.
   - **옵션 B — 재구성 + 판별 동시 미세조정**  
     - 소수 실제 이상에 대해 (x_anomaly, x_clean) 쌍이 있으면: 재구성 타깃 = 정상에 가깝게 만든 타깃(또는 동일 세션 내 정상 프레임).  
     - 없으면: 실제 이상 샘플을 “이상” 라벨로만 사용해 판별기만 미세조정(옵션 A와 유사).  
     - 재구성기는 실제 이상 입력에 대해 “정상으로 복원”하도록 소량 스텝만 업데이트(과적합 주의, 작은 learning rate).
   - **옵션 C — 메타/프로토타입 보정**  
     - 정상만으로 학습한 DREAM의 “정상 임베딩”과 소수 실제 이상 임베딩(재구성 오차·판별기 입력 등)으로 프로토타입 또는 거리 기준을 보정.  
     - 추론 시: 이상 점수 = 기존 DREAM 점수 + (실제 이상과의 유사도) 등으로 보정해 리콜을 끌어올림.
3. **평가**  
   - 검증 세트: 실제 이상 일부 + 정상 일부를 hold-out.  
   - **정확도(Accuracy), 정밀도(Precision), 리콜(Recall), F1, ROC AUC**를 추적.  
   - 소수 실제 이상 도입 전·후를 비교해 “획기적 향상” 여부를 정량적으로 보고.

## 구현 시 권장 사항

- **데이터 파이프라인**: 실제 이상 영상 → 기존 `prepare_training_data` / 특징 추출과 **동일 포맷**으로 맞춰 DREAM 입력과 호환.
- **과적합 방지**: 소수 실제 이상만 사용하므로  
  - 판별기 미세조정 시 **작은 learning rate**, **적은 epoch**, **조기 종료** 또는 **검증 리콜 기준 조기 종료**.  
  - 필요 시 **L2 정규화**, **Dropout 유지**.
- **임계값**: 미세조정 후 정상 검증 세트로 `set_threshold_from_normal(percentile=95)` 재계산하거나, 검증 세트에서 리콜·정밀도 트레이드오프로 임계값 선택.
- **버전 관리**: “정상만 모델” 체크포인트와 “소수 실제 이상 미세조정 모델” 체크포인트를 구분해 저장하고, 실험 로그(정확도·리콜·AUC)를 남긴다.

## 다음 단계 (구현 순서 제안)

1. **실제 이상 데이터 수집·라벨링**: 현미경 검사로 확인된 크랙 패널의 벤딩 측면 영상 → 특징 추출까지 파이프라인 확정.
2. **DREAM에 “미세조정” API 추가**:  
   - `fit_fewshot_anomaly(X_anomaly, X_normal_optional, epochs=10, lr=1e-4)` 등으로 판별기(및 선택적으로 재구성기)만 추가 학습.
3. **검증 스크립트 확장**: 합성 검증에 더해 “소수 실제 이상 + 정상” hold-out으로 정확도·리콜·AUC 보고.
4. **실험 및 문서화**: 소수 실제 이상 도입 전·후 메트릭을 기록하고, 전략(옵션 A/B/C)별로 권장 설정을 문서에 반영.

이 문서는 DREAM 모드 개발 완료 후, 소수 실제 이상 데이터를 활용한 정확도·리콜 향상의 **전략 기준**으로 사용한다.
